@echo off
chcp 65001 >nul
cls

echo.
echo ╔═══════════════════════════════════════════════════════╗
echo ║      🚀 إعداد كامل وتلقائي - مشروع MUN              ║
echo ╚═══════════════════════════════════════════════════════╝
echo.
echo هذا الملف سيقوم بـ:
echo  ✓ تثبيت جميع الحزم
echo  ✓ إعداد قاعدة البيانات
echo  ✓ إنشاء مستخدم Admin
echo  ✓ تثبيت التحديثات
echo  ✓ تشغيل الموقع
echo.
echo ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
echo.
pause

cd /d "%~dp0"

:: ═══════════════════════════════════════════════════════
:: الخطوة 1: تثبيت الحزم
:: ═══════════════════════════════════════════════════════
cls
echo.
echo ═══════════════════════════════════════════════════════
echo  📦 الخطوة 1/5: تثبيت الحزم
echo ═══════════════════════════════════════════════════════
echo.

if exist node_modules (
    echo ✅ المجلد node_modules موجود - تخطي التثبيت
    echo.
    set /p reinstall="هل تريد إعادة التثبيت؟ (y/n): "
    if /i "%reinstall%"=="y" (
        echo 🗑️ حذف node_modules...
        rmdir /s /q node_modules
        echo 📦 تثبيت الحزم...
        call npm install
    )
) else (
    echo 📦 تثبيت الحزم...
    call npm install
)

if %errorlevel% neq 0 (
    echo.
    echo ❌ فشل تثبيت الحزم!
    pause
    exit /b 1
)

echo.
echo ✅ تم تثبيت الحزم بنجاح!
timeout /t 2 >nul

:: ═══════════════════════════════════════════════════════
:: الخطوة 2: إعداد قاعدة البيانات
:: ═══════════════════════════════════════════════════════
cls
echo.
echo ═══════════════════════════════════════════════════════
echo  📊 الخطوة 2/5: إعداد قاعدة البيانات
echo ═══════════════════════════════════════════════════════
echo.

echo 📦 توليد Prisma Client...
call npx prisma generate

if %errorlevel% neq 0 (
    echo ❌ فشل توليد Prisma Client!
    pause
    exit /b 1
)

echo.
echo 📊 تطبيق Schema على قاعدة البيانات...
call npx prisma db push

if %errorlevel% neq 0 (
    echo ❌ فشل تطبيق Schema!
    pause
    exit /b 1
)

echo.
echo ✅ تم إعداد قاعدة البيانات بنجاح!
timeout /t 2 >nul

:: ═══════════════════════════════════════════════════════
:: الخطوة 3: إنشاء مستخدم Admin
:: ═══════════════════════════════════════════════════════
cls
echo.
echo ═══════════════════════════════════════════════════════
echo  👤 الخطوة 3/5: إنشاء مستخدم Admin
echo ═══════════════════════════════════════════════════════
echo.

call node scripts/create-admin.js

if %errorlevel% neq 0 (
    echo ⚠️ قد يكون المستخدم موجود مسبقاً
)

echo.
timeout /t 2 >nul

:: ═══════════════════════════════════════════════════════
:: الخطوة 4: تثبيت التحديثات
:: ═══════════════════════════════════════════════════════
cls
echo.
echo ═══════════════════════════════════════════════════════
echo  🔄 الخطوة 4/5: تثبيت التحديثات
echo ═══════════════════════════════════════════════════════
echo.

echo 📦 تثبيت jsonwebtoken...
call npm install jsonwebtoken @types/jsonwebtoken

if %errorlevel% neq 0 (
    echo ❌ فشل تثبيت التحديثات!
    pause
    exit /b 1
)

echo.
echo ✅ تم تثبيت التحديثات بنجاح!
timeout /t 2 >nul

:: ═══════════════════════════════════════════════════════
:: الخطوة 5: فحص نهائي
:: ═══════════════════════════════════════════════════════
cls
echo.
echo ═══════════════════════════════════════════════════════
echo  🔍 الخطوة 5/5: فحص نهائي
echo ═══════════════════════════════════════════════════════
echo.

call node check-all.js

echo.
echo ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
echo.
echo ✅ اكتمل الإعداد بنجاح! 🎉
echo.
echo 🚀 الآن يمكنك تشغيل الموقع
echo.
set /p run_now="هل تريد تشغيل الموقع الآن؟ (y/n): "

if /i "%run_now%"=="y" (
    cls
    echo.
    echo ═══════════════════════════════════════════════════════
    echo      🌐 تشغيل الموقع
    echo ═══════════════════════════════════════════════════════
    echo.
    echo 📍 الموقع: http://localhost:3001
    echo 🔐 البيانات: admin / admin123
    echo.
    echo ⚠️ لا تغلق هذه النافذة!
    echo.
    call npm run dev
) else (
    echo.
    echo 👍 حسناً! لتشغيل الموقع لاحقاً، شغّل: 4-run.bat
    echo.
    pause
)
